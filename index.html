<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimexBaku | Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --neon: #bf00ff; --deep: #05010a; --glass: rgba(255, 255, 255, 0.08); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--deep); color: white; font-family: 'Poppins', sans-serif; background-image: radial-gradient(circle at 50% 50%, #1a0533 0%, #05010a 100%); min-height: 100vh; }

        header {
            position: fixed; top: 0; width: 100%; z-index: 1000;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--neon);
        }

        .logo { font-family: 'Orbitron'; font-size: 24px; color: var(--neon); cursor: pointer; text-shadow: 0 0 15px var(--neon); }
        .page { display: none; padding: 120px 5% 50px; animation: fadeIn 0.4s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; max-width: 450px; margin: auto; backdrop-filter: blur(10px); }
        input, textarea { width: 100%; padding: 14px; margin: 10px 0; background: rgba(0,0,0,0.4); border: 1px solid var(--neon); border-radius: 12px; color: white; outline: none; }
        
        .btn { 
            background: linear-gradient(45deg, #8a2be2, var(--neon)); 
            color: white; border: none; padding: 14px 25px; border-radius: 12px; 
            font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; text-transform: uppercase;
        }
        .btn:hover { transform: scale(1.02); box-shadow: 0 0 25px var(--neon); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .p-card { background: var(--glass); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; position: relative; transition: 0.3s; }
        .p-img { width: 100%; height: 240px; object-fit: cover; background: #111; }
        .signature { position: fixed; bottom: 10px; right: 10px; font-size: 10px; color: #1a1a1a; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="showPage('homePage')">TIMEXBAKU</div>
    <div id="navButtons"></div>
</header>

<div id="regPage" class="page active">
    <div class="card">
        <h2 style="font-family: Orbitron; margin-bottom: 20px; color: var(--neon); text-align:center;">QEYDİYYAT</h2>
        <input type="text" id="regName" placeholder="İstifadəçi adı">
        <input type="password" id="regPass" placeholder="Şifrə">
        <input type="text" id="regPhone" value="+994" maxlength="13">
        <button class="btn" onclick="register()">QEYD OL</button>
        <p style="text-align:center; margin-top:20px; font-size:13px;">Hesabın var? <span onclick="showPage('loginPage')" style="color:var(--neon); cursor:pointer;">Giriş et</span></p>
    </div>
</div>

<div id="loginPage" class="page">
    <div class="card">
        <h2 style="font-family: Orbitron; margin-bottom: 20px; color: var(--neon); text-align:center;">GİRİŞ</h2>
        <input type="text" id="logName" placeholder="Ad və ya ID">
        <input type="password" id="logPass" placeholder="Şifrə">
        <button class="btn" onclick="login()">DAXİL OL</button>
    </div>
</div>

<div id="homePage" class="page">
    <h2 style="font-family: Orbitron; margin-bottom: 30px;">GLOBAL MARKET</h2>
    <div class="grid" id="mainGrid"></div>
</div>

<div id="shopPage" class="page">
    <div class="card" id="setupShopCard">
        <h3 style="color:var(--neon)">MAĞAZA AKTİVASİYASI</h3>
        <p style="font-size: 13px; color: #ccc; margin: 15px 0;">Zəhmət olmasa mağaza adını daxil edib təsdiqləyin.</p>
        <input type="text" id="shopNameInput" placeholder="Mağaza adınız">
        <button class="btn" onclick="setupShop()">TƏSDİQLƏ</button>
    </div>
    <div id="postAdSection" style="display:none;">
        <div class="card">
            <h3 style="color:var(--neon); margin-bottom:15px;">YENİ ELAN</h3>
            <input type="text" id="pTitle" placeholder="Məhsul adı">
            <input type="number" id="pPrice" placeholder="Qiymət (AZN)">
            <input type="file" id="pFiles" accept="image/*">
            <button class="btn" onclick="createAd()">PAYLAŞ</button>
        </div>
    </div>
</div>

<div class="signature" onclick="adminTrigger()">ismayilismayilov</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBxDEz5-5JBRKWruTErQ5GmMCX9we0iP00",
        authDomain: "bitbattle-64c13.firebaseapp.com",
        projectId: "bitbattle-64c13",
        storageBucket: "bitbattle-64c13.firebasestorage.app",
        messagingSenderId: "735228613710",
        appId: "1:735228613710:web:14a6cee6f896ceffc11f1f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = JSON.parse(localStorage.getItem('timexUser')) || null;

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'shopPage') checkShopUI();
        updateNav();
    }

    function updateNav() {
        const nav = document.getElementById('navButtons');
        if(currentUser) {
            nav.innerHTML = `
                <span style="color:var(--neon); margin-right:15px; font-weight:bold">${currentUser.id}</span>
                <button class="btn" style="width:auto; padding:8px 15px" onclick="showPage('shopPage')"><i class="fas fa-store"></i></button>
                <button onclick="logout()" style="background:none; border:none; color:white; margin-left:15px; cursor:pointer"><i class="fas fa-power-off"></i></button>`;
        }
    }

    function checkShopUI() {
        if(currentUser && currentUser.hasShop) {
            document.getElementById('setupShopCard').style.display = 'none';
            document.getElementById('postAdSection').style.display = 'block';
        } else {
            document.getElementById('setupShopCard').style.display = 'block';
            document.getElementById('postAdSection').style.display = 'none';
        }
    }

    async function register() {
        const name = document.getElementById('regName').value.trim();
        const pass = document.getElementById('regPass').value;
        const phone = document.getElementById('regPhone').value.trim();
        const id = "t" + Math.floor(10000 + Math.random() * 90000);

        if(!name || !pass) return alert("Xanaları doldurun!");

        const userObj = { id, name, pass, phone, hasShop: false, status: 'Active' };
        try {
            await db.collection("users").doc(id).set(userObj);
            currentUser = userObj;
            localStorage.setItem('timexUser', JSON.stringify(currentUser));
            showPage('homePage');
        } catch(e) { alert("Xəta: Verilənlər bazasına yazıla bilmədi."); }
    }

    async function login() {
        const name = document.getElementById('logName').value;
        const pass = document.getElementById('logPass').value;
        const res = await db.collection("users").where("name", "==", name).where("pass", "==", pass).get();
        if(res.empty) return alert("Məlumatlar səhvdir!");
        currentUser = res.docs[0].data();
        localStorage.setItem('timexUser', JSON.stringify(currentUser));
        showPage('homePage');
        loadAds();
    }

    // MAĞAZA TƏSDİQLƏMƏ FUNKSİYASI (Yeniləndi)
    async function setupShop() {
        const sName = document.getElementById('shopNameInput').value;
        if(!sName) return alert("Mağaza adı yazın!");
        if(!currentUser) return alert("Əvvəlcə giriş edin!");

        try {
            // Həm bazada, həm də yerli yaddaşda statusu yeniləyirik
            await db.collection("users").doc(currentUser.id).set({
                ...currentUser,
                hasShop: true,
                shopName: sName
            }, { merge: true });

            currentUser.hasShop = true;
            currentUser.shopName = sName;
            localStorage.setItem('timexUser', JSON.stringify(currentUser));
            
            alert("Mağaza uğurla təsdiqləndi!");
            checkShopUI();
        } catch(e) { 
            console.error(e);
            alert("Xəta: Mağaza təsdiqlənə bilmədi. Firestore qaydalarını (Rules) yoxlayın."); 
        }
    }

    async function createAd() {
        const title = document.getElementById('pTitle').value;
        const price = document.getElementById('pPrice').value;
        const file = document.getElementById('pFiles').files[0];
        if(!file || !title) return alert("Məlumatları doldurun!");

        const reader = new FileReader();
        reader.onload = async function(e) {
            await db.collection("ads").add({
                title, price, img: e.target.result,
                sellerId: currentUser.id, sellerPhone: currentUser.phone,
                time: Date.now()
            });
            alert("Elan paylaşıldı!");
            showPage('homePage');
            loadAds();
        }
        reader.readAsDataURL(file);
    }

    async function loadAds() {
        const res = await db.collection("ads").orderBy("time", "desc").get();
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = "";
        res.forEach(doc => {
            const ad = doc.data();
            grid.innerHTML += `
                <div class="p-card">
                    <img src="${ad.img}" class="p-img">
                    <div style="padding:15px">
                        <h4>${ad.title}</h4>
                        <div style="color:var(--neon); font-size:20px; font-weight:bold">${ad.price} AZN</div>
                        <button class="btn" style="margin-top:10px" onclick="window.open('https://wa.me/${ad.sellerPhone}')">ALMAQ</button>
                    </div>
                </div>`;
        });
    }

    function logout() { localStorage.removeItem('timexUser'); location.reload(); }

    if(currentUser) { showPage('homePage'); loadAds(); }
</script>
</body>
</html>
